<%
  const flatDomxNodes = document.nodes;

  function renderDomxNode(domxNode, indentSize = 2) {
    if (!domxNode) return '';

    const tagName = domxNode.name.toLowerCase();
    const attributes = renderDomxNodeAttributes(domxNode);
    const content = renderDomxNodeContent(domxNode);

    return `<${tagName}${(attributes ?? '') !== '' ? ' ' + attributes : ''}>${content}</${tagName}>`.replace(/^/gm, ' '.repeat(indentSize));
  }

  function renderDomxNodeAttributes(domxNode) {
    const renderedAttributes = {};

    Object.keys(domxNode.attributes).forEach((key) => {
      renderedAttributes[key] = render(domxNode.attributes[key], flatDomxNodes);
    });

    return Object.entries(renderedAttributes).map(([key, val]) => `${key}="${val}"`).join(' ');
  }

  function renderDomxNodeContent(domxNode) {
    let content = renderDomxNodeChildren(domxNode);

    if (content.trim() !== '') {
      return `\n${content}\n`;
    }

    if (domxNode.text) {
      return domxNode.text.replaceAll('\n', '<br />');
    }

    return '';
  }

  function renderDomxNodeChildren(domxNode, indentSize = 2) {
    if (!domxNode) return '';

    const children = domxNode.childrenIds.map((childId) => flatDomxNodes[childId]);

    return children.map((child) => renderDomxNode(child, indentSize)).join(`\n`);
  }
-%>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%- document.metadata.figmaFile.name %></title>
  <link media="all" rel="stylesheet" href="./styles.css"></link>
<%- renderDomxNodeChildren(flatDomxNodes[document.headId]) %>
</head>
<%- renderDomxNode(flatDomxNodes[document.bodyId], 0) %>
</html>
