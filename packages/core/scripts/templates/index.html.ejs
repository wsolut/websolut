<%
  const flatDomxNodes = document.nodes;

  function renderDomxNode(domxNode) {
    const tagName = domxNode.name.toLowerCase();
    const attributes = renderDomxNodeAttributes(domxNode.attributes);
    const content = renderDomxNodeContent(domxNode);

    return beautifyHtml(
      `<${tagName}${(attributes ?? '') !== '' ? ' ' + attributes : ''}>${content}</${tagName}>`,
      { indent_size: 2 }
    );
  }

  function renderDomxNodeAttributes(attributes) {
    const renderedAttributes = {};

    Object.keys(attributes).forEach((key) => {
      renderedAttributes[key] = render(attributes[key], flatDomxNodes);
    });

    return Object.entries(renderedAttributes).map(([key, val]) => `${key}="${val}"`).join(' ');
  }

  function renderDomxNodeContent(domxNode) {
    let content = renderDomxNodeChildren(domxNode);

    if (domxNode.text) {
      // Handle multiple types of line breaks and whitespace characters
      const processedValue = processTextValue(domxNode.text);

      content = `${processedValue}${content}`;
    }

    if (content.trim() !== '') {
      content = `\n${content}\n`;
    }

    return beautifyHtml(content, { indent_size: 2 });
  }

  function renderDomxNodeChildren(domxNode) {
    const children = domxNode.childrenIds.map((childId) => flatDomxNodes[childId]);

    return children.map((child) => renderDomxNode(child)).join(`\n`);
  }

  function processTextValue(text) {
    return (
      text
        // Standard newline (LF)
        .replace(/\n/g, '<br />')
        // Carriage return + line feed (CRLF)
        .replace(/\r\n/g, '<br />')
        // Carriage return only (CR)
        .replace(/\r/g, '<br />')
        // Unicode line separator
        .replace(/\u2028/g, '<br />')
        // Unicode paragraph separator
        .replace(/\u2029/g, '<br />')
        // Next line (NEL)
        .replace(/\u0085/g, '<br />')
        // Vertical tab
        .replace(/\v/g, '<br />')
    );
  }
-%>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%- document.metadata.figmaFile.name %></title>
  <link media="all" rel="stylesheet" href="./styles.css"></link>
</head>
<%- renderDomxNode(flatDomxNodes[document.bodyId]) %>
</html>
